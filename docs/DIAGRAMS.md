# Диаграммы и визуализации

## Архитектура системы

```
┌─────────────────────────────────────────────────────────────────┐
│                         User Browser                             │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              React Frontend (Vite)                      │    │
│  │                                                          │    │
│  │  ┌─────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │   Pages     │  │  Components  │  │  API Client  │  │    │
│  │  │             │  │              │  │              │  │    │
│  │  │ - Home      │  │ - Header     │  │ - domains    │  │    │
│  │  │ - Domains   │  │ - Graph      │  │ - nodes      │  │    │
│  │  │ - Graph     │  │ - Forms      │  │ - edges      │  │    │
│  │  └─────────────┘  └──────────────┘  └──────────────┘  │    │
│  │                                                          │    │
│  │  State Management: React Query + Zustand                │    │
│  │  UI Library: Ant Design                                 │    │
│  │  Graph: Cytoscape.js                                    │    │
│  └────────────────────────────────────────────────────────┘    │
└──────────────────────────┬───────────────────────────────────────┘
                           │ HTTP/HTTPS (REST + GraphQL)
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Backend Server (Node.js)                     │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │              NestJS Application                         │    │
│  │                                                          │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │            API Layer                             │  │    │
│  │  │  ┌──────────────┐      ┌──────────────┐         │  │    │
│  │  │  │ REST API     │      │  GraphQL     │         │  │    │
│  │  │  │ (Controllers)│      │  (Resolvers) │         │  │    │
│  │  │  └──────────────┘      └──────────────┘         │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │          Business Logic Layer                    │  │    │
│  │  │                                                   │  │    │
│  │  │  ┌──────────┐  ┌─────────┐  ┌──────────┐       │  │    │
│  │  │  │ Domains  │  │  Nodes  │  │  Edges   │       │  │    │
│  │  │  │ Service  │  │ Service │  │ Service  │       │  │    │
│  │  │  └──────────┘  └─────────┘  └──────────┘       │  │    │
│  │  │                                                   │  │    │
│  │  │  ┌──────────┐  ┌─────────┐  ┌──────────┐       │  │    │
│  │  │  │  Users   │  │ Ratings │  │   Auth   │       │  │    │
│  │  │  │ Service  │  │ Service │  │ Service  │       │  │    │
│  │  │  └──────────┘  └─────────┘  └──────────┘       │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  ┌──────────────────────────────────────────────────┐  │    │
│  │  │           Data Access Layer                      │  │    │
│  │  │                                                   │  │    │
│  │  │         TypeORM Repositories                     │  │    │
│  │  │  ┌────────────────────────────────────────┐     │  │    │
│  │  │  │  Entity Manager & Query Builder        │     │  │    │
│  │  │  └────────────────────────────────────────┘     │  │    │
│  │  └──────────────────────────────────────────────────┘  │    │
│  │                                                          │    │
│  │  Middleware: JWT Auth, Validation, i18n, Logging        │    │
│  └────────────────────────────────────────────────────────┘    │
└──────────────────────────┬───────────────────────────────────────┘
                           │ SQL Queries
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      PostgreSQL Database                         │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   users     │  │   domains   │  │ node_types  │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │    nodes    │  │ edge_types  │  │    edges    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                                  │
│  ┌─────────────┐                                                │
│  │   ratings   │                                                │
│  └─────────────┘                                                │
│                                                                  │
│  Extensions: uuid-ossp, pg_trgm, btree_gin                     │
└─────────────────────────────────────────────────────────────────┘
```

## Структура данных (Entity Relationship Diagram)

```
┌──────────────────┐
│      User        │
│──────────────────│
│ + id: UUID       │◄──┐
│ + email          │   │
│ + username       │   │ created_by
│ + password       │   │
│ + roles[]        │   │
└──────────────────┘   │
         │             │
         │ creates     │
         ▼             │
┌──────────────────┐   │
│     Domain       │   │
│──────────────────│   │
│ + id: UUID       │───┘
│ + name           │
│ + slug           │◄────────────┐
│ + description    │             │
│ + translations   │             │ belongs_to
│ + isPublic       │             │
│ + settings       │             │
└──────────────────┘             │
    │           │                │
    │ has       │ has            │
    ▼           ▼                │
┌────────────┐ ┌────────────┐   │
│ NodeType   │ │ EdgeType   │   │
│────────────│ │────────────│   │
│ + id       │ │ + id       │   │
│ + name     │ │ + name     │   │
│ + slug     │ │ + semantic │   │
│ + schema   │ │ + weight   │   │
│ + icon     │ │ + directed │   │
└────────────┘ └────────────┘   │
    │               │            │
    │ defines       │ defines    │
    ▼               ▼            │
┌─────────────┐  ┌──────────┐   │
│    Node     │  │   Edge   │   │
│─────────────│  │──────────│───┘
│ + id        │◄─┤ sourceId │
│ + title     │  │ targetId │───┐
│ + content   │  │ typeId   │   │
│ + data      │◄─└──────────┘   │
│ + tags[]    │                 │
│ + status    │                 │
└─────────────┘                 │
    │                           │
    │ has                       │
    ▼                           │
┌─────────────┐                 │
│   Rating    │                 │
│─────────────│                 │
│ + id        │                 │
│ + nodeId    │─────────────────┘
│ + type      │
│ + score     │
│ + details   │
└─────────────┘
```

## Поток данных: Создание узла

```
User Browser                Frontend              Backend              Database
     │                         │                     │                    │
     │  1. Click "Create Node" │                     │                    │
     ├────────────────────────►│                     │                    │
     │                         │                     │                    │
     │  2. Fill form           │                     │                    │
     │     (title, content)    │                     │                    │
     ├────────────────────────►│                     │                    │
     │                         │                     │                    │
     │  3. Submit              │  POST /api/nodes    │                    │
     ├────────────────────────►├────────────────────►│                    │
     │                         │  { title, content } │                    │
     │                         │                     │                    │
     │                         │                     │  4. Validate       │
     │                         │                     │     - DTO          │
     │                         │                     │     - Schema       │
     │                         │                     │                    │
     │                         │                     │  5. INSERT node    │
     │                         │                     ├───────────────────►│
     │                         │                     │                    │
     │                         │                     │  6. Return node    │
     │                         │                     │◄───────────────────┤
     │                         │                     │                    │
     │                         │  7. Return 201      │                    │
     │                         │◄────────────────────┤                    │
     │  8. Show success        │     { node }        │                    │
     │◄────────────────────────┤                     │                    │
     │                         │                     │                    │
     │  9. Redirect to graph   │  GET /api/nodes/... │                    │
     ├────────────────────────►├────────────────────►├───────────────────►│
     │                         │                     │◄───────────────────┤
     │  10. Render graph       │◄────────────────────┤                    │
     │◄────────────────────────┤                     │                    │
```

## Процесс расчета рейтинга

```
                    ┌─────────────────┐
                    │  Rating Request │
                    └────────┬────────┘
                             │
                             ▼
            ┌────────────────────────────────┐
            │  Get Node + All Related Edges  │
            └────────────┬───────────────────┘
                         │
                         ▼
        ┌────────────────────────────────────────┐
        │     Calculate Individual Metrics       │
        └────────────┬───────────────────────────┘
                     │
         ┌───────────┼───────────┐
         │           │           │
         ▼           ▼           ▼
┌────────────┐ ┌──────────┐ ┌────────────┐
│Consistency │ │Coherence │ │Connectivity│
│            │ │          │ │            │
│ supports:  │ │connected │ │  edges /   │
│   +15      │ │  nodes:  │ │  possible  │
│contradicts:│ │   45/50  │ │  edges     │
│   -2       │ │          │ │            │
│            │ │          │ │            │
│ = 0.87     │ │ = 0.90   │ │ = 0.45     │
└────────────┘ └──────────┘ └────────────┘
         │           │           │
         └───────────┼───────────┘
                     ▼
         ┌───────────────────────┐
         │   Calculate Overall   │
         │                       │
         │ 0.4×0.87 + 0.3×0.90   │
         │      + 0.3×0.45       │
         │                       │
         │     = 0.753           │
         └───────────┬───────────┘
                     │
                     ▼
         ┌───────────────────────┐
         │  Save Rating to DB    │
         │                       │
         │ - score: 0.753        │
         │ - metric: overall     │
         │ - details: {...}      │
         └───────────────────────┘
```

## Граф знаний: Пример физической теории

```
                    ┌─────────────────────────┐
                    │      Концепция:         │
                    │   "Эфиродинамика"       │
                    │   Rating: 0.85          │
                    └───────────┬─────────────┘
                                │ part_of
                ┌───────────────┼───────────────┐
                │               │               │
                ▼               ▼               ▼
        ┌───────────┐   ┌───────────┐  ┌───────────┐
        │  Теория:  │   │  Теория:  │  │  Теория:  │
        │Механич.   │   │ Вихревая  │  │ Волновая  │
        │ эфир      │   │  модель   │  │  модель   │
        │Rating:0.75│   │Rating:0.82│  │Rating:0.78│
        └─────┬─────┘   └─────┬─────┘  └─────┬─────┘
              │               │               │
    ┌─────────┼───────┐       │               │
    │         │       │       │               │
    ▼         ▼       ▼       ▼               ▼
┌────────┐┌────────┐┌────────┐┌────────┐┌────────┐
│Аксиома ││Аксиома ││Экспер. ││Экспер. ││Экспер. │
│Существ.││Неподв. ││М-М     ││Спектр. ││Интерф. │
│эфира   ││эфира   ││1887    ││линии   ││света   │
└────────┘└────────┘└────┬───┘└────────┘└────────┘
                         │
              ┌──────────┼──────────┐
              │          │          │
              ▼          ▼          ▼
        ┌──────────┐┌──────────┐┌──────────┐
        │Трактовка││Трактовка││Трактовка│
        │"Эфир    ││"Сокращ. ││"Относит.│
        │неподв." ││Лоренца" ││движения"│
        └──────────┘└──────────┘└──────────┘

Связи:
━━━━━ derives_from (следует из)
─ ─ ─ supports (подтверждает)
╌╌╌╌╌ contradicts (противоречит)
```

## Deployment Architecture (Production)

```
                    ┌─────────────────┐
                    │   CloudFlare    │
                    │      CDN        │
                    └────────┬────────┘
                             │ HTTPS
                    ┌────────┴────────┐
                    │  Load Balancer  │
                    │     (nginx)     │
                    └────────┬────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
    ┌──────────┐       ┌──────────┐      ┌──────────┐
    │ Backend  │       │ Backend  │      │ Backend  │
    │Instance 1│       │Instance 2│      │Instance 3│
    └────┬─────┘       └────┬─────┘      └────┬─────┘
         │                  │                  │
         └──────────────────┼──────────────────┘
                            │
                   ┌────────┴────────┐
                   │  PostgreSQL     │
                   │   (Master)      │
                   └────────┬────────┘
                            │
                   ┌────────┴────────┐
                   │  PostgreSQL     │
                   │  (Read Replica) │
                   └─────────────────┘

    ┌──────────────────────────────────────┐
    │           Monitoring Stack            │
    │                                       │
    │  ┌──────────┐  ┌──────────┐         │
    │  │Prometheus│  │ Grafana  │         │
    │  └──────────┘  └──────────┘         │
    │                                       │
    │  ┌──────────┐  ┌──────────┐         │
    │  │  Sentry  │  │   ELK    │         │
    │  └──────────┘  └──────────┘         │
    └──────────────────────────────────────┘
```

## User Journey: Создание научной теории

```
1. Регистрация
   User → Register Page → Backend → DB
   ↓
2. Создание домена
   User → Create Domain → "Physics Theories"
   ↓
3. Настройка типов узлов
   User → Define NodeTypes:
          - Axiom
          - Theory
          - Experiment
          - Interpretation
   ↓
4. Настройка типов связей
   User → Define EdgeTypes:
          - derives_from
          - supports
          - contradicts
   ↓
5. Создание узлов
   User → Create Nodes:
          - "Principle of Relativity"
          - "M-M Experiment"
          - "Special Relativity"
   ↓
6. Связывание узлов
   User → Create Edges:
          Experiment → supports → Theory
          Theory → derives_from → Axiom
   ↓
7. Просмотр графа
   User → Graph View → Interactive visualization
   ↓
8. Анализ рейтингов
   User → View Ratings → Identify weak points
   ↓
9. Улучшение теории
   User → Add supporting evidence
          → Fix contradictions
```

## Технологический стек - визуализация

```
┌────────────────────────────────────────────────────────────┐
│                        PRESENTATION                         │
├────────────────────────────────────────────────────────────┤
│  React 18  │  TypeScript  │  Ant Design  │  Cytoscape.js  │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                          STATE                              │
├────────────────────────────────────────────────────────────┤
│     React Query    │    Zustand    │    React Router       │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                          API                                │
├────────────────────────────────────────────────────────────┤
│          REST API          │         GraphQL API           │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                       APPLICATION                           │
├────────────────────────────────────────────────────────────┤
│    NestJS   │  TypeScript  │  Passport  │   nestjs-i18n   │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                          DATA                               │
├────────────────────────────────────────────────────────────┤
│       TypeORM        │          PostgreSQL 15              │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│                      INFRASTRUCTURE                         │
├────────────────────────────────────────────────────────────┤
│   Docker   │  Docker Compose  │  nginx  │  (optional) K8s │
└────────────────────────────────────────────────────────────┘
```

Эти диаграммы помогут понять структуру и работу системы на разных уровнях.
